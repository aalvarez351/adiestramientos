<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Búsqueda de Clientes - Sistema de Préstamos" />
        <meta name="author" content="" />
        <title>Búsqueda de Clientes - Sistema de Préstamos</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
        <link href="css/styles.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <script src="js/pagination.js"></script>
        <style>
            .search-container {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
                padding: 2rem;
                margin-bottom: 2rem;
                color: white;
            }
            .client-card {
                border: none;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                transition: transform 0.3s ease;
            }
            .client-card:hover {
                transform: translateY(-5px);
            }
            .print-section {
                display: none;
            }
            @media print {
                .no-print {
                    display: none !important;
                }
                .print-section {
                    display: block !important;
                }
                body {
                    background: white !important;
                }
                .container {
                    max-width: none !important;
                    margin: 0 !important;
                    padding: 0 !important;
                }
            }
        </style>
    </head>
    <body class="sb-nav-fixed">
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
            <!-- Navbar Brand-->
            <a class="navbar-brand ps-3" href="loan-admin.html">Sistema de Préstamos</a>
            <!-- Sidebar Toggle-->
            <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
            <!-- Navbar Search-->
            <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
                <div class="input-group">
                    <input class="form-control" type="text" placeholder="Buscar..." aria-label="Search for..." aria-describedby="btnNavbarSearch" />
                    <button class="btn btn-primary" id="btnNavbarSearch" type="button"><i class="fas fa-search"></i></button>
                </div>
            </form>
            <!-- Navbar-->
            <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="#" onclick="logout()">Cerrar Sesión</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <div class="sb-sidenav-menu-heading">Principal</div>
                            <a class="nav-link" href="loan-admin.html">
                                <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                                Dashboard
                            </a>
                            <div class="sb-sidenav-menu-heading">Gestión</div>
                            <a class="nav-link" href="#" onclick="window.location.href='loan-admin.html'; showClients()">
                                <div class="sb-nav-link-icon"><i class="fas fa-users"></i></div>
                                Clientes
                            </a>
                            <a class="nav-link" href="#" onclick="window.location.href='loan-admin.html'; showLoans()">
                                <div class="sb-nav-link-icon"><i class="fas fa-money-bill-wave"></i></div>
                                Préstamos
                            </a>
                            <a class="nav-link" href="#" onclick="window.location.href='loan-admin.html'; showPayments()">
                                <div class="sb-nav-link-icon"><i class="fas fa-receipt"></i></div>
                                Pagos
                            </a>
                            <a class="nav-link" href="#" onclick="window.location.href='loan-admin.html'; showReports()">
                                <div class="sb-nav-link-icon"><i class="fas fa-chart-bar"></i></div>
                                Reportes
                            </a>
                        </div>
                    </div>
                    <div class="sb-sidenav-footer">
                        <div class="small">Conectado como Admin</div>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h1 class="mt-4 mb-0">Búsqueda de Clientes</h1>
                                <p class="text-muted">Buscar cliente y ver historial completo</p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">Última actualización</small>
                                <small class="text-muted" id="lastUpdate"></small>
                            </div>
                        </div>

                        <!-- Search Section -->
                        <div class="search-container">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h4><i class="fas fa-search me-2"></i>Buscar Cliente</h4>
                                    <p class="mb-0">Ingresa el nombre, apellido o email del cliente</p>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-lg" id="searchInput" placeholder="Buscar cliente..." onkeyup="searchClients()">
                                        <button class="btn btn-light btn-lg" type="button" onclick="clearSearch()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div id="searchResults" style="display: none;">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Resultados de Búsqueda</h5>
                                    <div class="no-print">
                                        <button class="btn btn-outline-primary me-2" onclick="printClientReport()">
                                            <i class="fas fa-print me-1"></i>Imprimir Reporte
                                        </button>
                                        <button class="btn btn-outline-success" onclick="exportSearchResults()">
                                            <i class="fas fa-download me-1"></i>Exportar Resultados
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="clientsList">
                                        <!-- Client results will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Client Details Section -->
                        <div id="clientDetails" style="display: none;">
                            <!-- Client Information -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Información del Cliente</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="clientInfo">
                                        <!-- Client info will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Loans History -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Historial de Préstamos</h5>
                                </div>
                                <div class="card-body">
                                    <div id="clientLoansSearchBar"></div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="clientLoansTable">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>ID Préstamo</th>
                                                    <th>Capital</th>
                                                    <th>Plazo</th>
                                                    <th>Tasa Interés</th>
                                                    <th>Estado</th>
                                                    <th>Fecha Creación</th>
                                                    <th>Saldo Actual</th>
                                                </tr>
                                            </thead>
                                            <tbody id="loansTableBody">
                                                <!-- Loans will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Payments History -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Historial de Pagos</h5>
                                </div>
                                <div class="card-body">
                                    <div id="clientPaymentsSearchBar"></div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="clientPaymentsTable">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Fecha</th>
                                                    <th>Monto</th>
                                                    <th>Tipo</th>
                                                    <th>Comprobante</th>
                                                    <th>Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentsTableBody">
                                                <!-- Payments will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Summary Statistics -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Resumen Estadístico</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="clientSummary">
                                        <!-- Summary stats will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Client Details Modal -->
                        <div class="modal fade" id="clientDetailsModal" tabindex="-1">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Detalles Completos del Cliente</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body" id="clientDetailsModalBody">
                                        <!-- Client details will be loaded here -->
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                        <button type="button" class="btn btn-primary" onclick="exportClientFromModal()">Exportar</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Print Section (Hidden by default, shown only when printing) -->
                        <div class="print-section">
                            <div class="text-center mb-4">
                                <h2>Sistema de Gestión de Préstamos</h2>
                                <h4>Reporte de Cliente</h4>
                                <p>Fecha de generación: <span id="printDate"></span></p>
                            </div>
                            <div id="printContent">
                                <!-- Print content will be populated here -->
                            </div>
                        </div>
                    </div>
                </main>
                <footer class="py-4 bg-light mt-auto no-print">
                    <div class="container-fluid px-4">
                        <div class="d-flex align-items-center justify-content-between small">
                            <div class="text-muted">Copyright &copy; Sistema de Préstamos 2024</div>
                        </div>
                    </div>
                </footer>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="js/scripts.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            let allClients = [];
            let selectedClient = null;
            let clientLoansPagination, clientPaymentsPagination;

            document.addEventListener('DOMContentLoaded', function() {
                console.log('client-search.html loaded');
                validateLoanAdminAccess();
                loadAllClients();
                setupNavbarSearch();
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-ES');

                // Check for client parameter in URL - only redirect if coming from external link
                const urlParams = new URLSearchParams(window.location.search);
                const clientId = urlParams.get('client');
                if (clientId && document.referrer && !document.referrer.includes('client-search.html')) {
                    console.log('Redirecting to client details from URL parameter');
                    window.location.href = `client-details.html?client=${clientId}`;
                }
            });

            function validateLoanAdminAccess() {
                const token = localStorage.getItem('token');
                const role = localStorage.getItem('role');

                console.log('Validating access - Token:', !!token, 'Role:', role);

                if (!token || role !== 'administradores2') {
                    console.log('Access denied - redirecting to login');
                    alert('Acceso no autorizado. Debes iniciar sesión como administrador de préstamos.');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('Access granted');
            }

            async function loadAllClients() {
                try {
                    console.log('Loading all clients...');
                    const token = localStorage.getItem('token');
                    console.log('Token available:', !!token);

                    const response = await fetch('http://localhost:3000/api/clientes', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });

                    console.log('Clients API response status:', response.status);

                    if (response.ok) {
                        allClients = await response.json();
                        console.log('Clients loaded successfully:', allClients.length, 'clients');
                    } else {
                        console.error('Failed to load clients:', response.status, response.statusText);
                    }
                } catch (err) {
                    console.error('Error loading clients:', err);
                }
            }

            function searchClients() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                const resultsContainer = document.getElementById('clientsList');

                console.log('Search term:', searchTerm, 'Length:', searchTerm.length);
                console.log('Total clients available:', allClients.length);

                if (searchTerm.length < 2) {
                    document.getElementById('searchResults').style.display = 'none';
                    return;
                }

                const filteredClients = allClients.filter(client => {
                    const matches = (client.nombre && client.nombre.toLowerCase().includes(searchTerm)) ||
                        (client.apellido && client.apellido.toLowerCase().includes(searchTerm)) ||
                        (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                        (client.telefono && client.telefono.includes(searchTerm)) ||
                        (client.direccion && client.direccion.toLowerCase().includes(searchTerm));

                    if (matches) {
                        console.log('Client match:', client.nombre, client.apellido, client.email);
                    }

                    return matches;
                });

                console.log('Filtered clients:', filteredClients.length);

                if (filteredClients.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No se encontraron clientes que coincidan con "${searchTerm}"</p>
                        </div>
                    `;
                } else {
                    // Create table with all client information
                    resultsContainer.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="clientsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Nombre Completo</th>
                                        <th>Email</th>
                                        <th>Teléfono</th>
                                        <th>Dirección</th>
                                        <th>Tipo</th>
                                        <th>Fecha Registro</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="clientsTableBody">
                                    ${filteredClients.map(client => `
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px; font-size: 0.9rem; font-weight: bold;">
                                                        ${client.nombre.charAt(0)}${client.apellido.charAt(0)}
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold">${client.nombre} ${client.apellido}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${client.email}</td>
                                            <td>${client.telefono}</td>
                                            <td>${client.direccion || 'No especificada'}</td>
                                            <td><span class="badge bg-info">${client.tipo}</span></td>
                                            <td>${new Date(client.fecha_registro).toLocaleDateString('es-ES')}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewClientDetails('${client._id}')" title="Ver detalles completos">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-success" onclick="window.location.href='client-details.html?client=${client._id}'" title="Ver historial completo">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                document.getElementById('searchResults').style.display = 'block';
            }

            async function selectClient(clientId) {
                try {
                    selectedClient = allClients.find(c => c._id === clientId);

                    // Load client loans and payments
                    const [loansRes, paymentsRes] = await Promise.all([
                        fetch('http://localhost:3000/api/prestamos', {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        }),
                        fetch('http://localhost:3000/api/pagos', {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        })
                    ]);

                    if (loansRes.ok && paymentsRes.ok) {
                        const allLoans = await loansRes.json();
                        const allPayments = await paymentsRes.json();

                        const clientLoans = allLoans.filter(loan => loan.cliente_id === clientId);
                        const clientPayments = allPayments.filter(payment => payment.cliente_info && payment.cliente_info.email === selectedClient.email);

                        displayClientDetails(selectedClient, clientLoans, clientPayments);
                        document.getElementById('clientDetails').style.display = 'block';

                        // Scroll to client details
                        document.getElementById('clientDetails').scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) {
                    console.error('Error loading client details:', err);
                }
            }

            function displayClientDetails(client, loans, payments) {
                // Client Info
                const clientInfo = document.getElementById('clientInfo');
                clientInfo.innerHTML = `
                    <div class="col-md-6">
                        <h6>Información Personal</h6>
                        <p><strong>Nombre:</strong> ${client.nombre} ${client.apellido}</p>
                        <p><strong>Email:</strong> ${client.email}</p>
                        <p><strong>Teléfono:</strong> ${client.telefono}</p>
                        <p><strong>Dirección:</strong> ${client.direccion || 'No especificada'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Estadísticas Generales</h6>
                        <p><strong>Tipo de Cliente:</strong> <span class="badge bg-info">${client.tipo}</span></p>
                        <p><strong>Fecha de Registro:</strong> ${new Date(client.fecha_registro).toLocaleDateString('es-ES')}</p>
                        <p><strong>Total de Préstamos:</strong> ${loans.length}</p>
                        <p><strong>Total de Pagos:</strong> ${payments.length}</p>
                    </div>
                `;

                // Configurar paginación para préstamos del cliente
                if (!clientLoansPagination) {
                    clientLoansPagination = new PaginationManager('clientLoansTable', {
                        pageSize: 5,
                        renderCallback: renderClientLoansTable,
                        searchCallback: searchClientLoans,
                        labels: { records: 'préstamos' }
                    });
                    
                    document.getElementById('clientLoansSearchBar').innerHTML = 
                        clientLoansPagination.createSearchBar('Buscar préstamos...');
                }
                clientLoansPagination.setData(loans);

                // Configurar paginación para pagos del cliente
                if (!clientPaymentsPagination) {
                    clientPaymentsPagination = new PaginationManager('clientPaymentsTable', {
                        pageSize: 10,
                        renderCallback: renderClientPaymentsTable,
                        searchCallback: searchClientPayments,
                        labels: { records: 'pagos' }
                    });
                    
                    document.getElementById('clientPaymentsSearchBar').innerHTML = 
                        clientPaymentsPagination.createSearchBar('Buscar pagos...');
                }
                clientPaymentsPagination.setData(payments);

                // Summary Statistics
                const totalLoans = loans.length;
                const activeLoans = loans.filter(l => l.estado === 'activo').length;
                const totalBorrowed = loans.reduce((sum, l) => sum + l.capital_inicial, 0);
                const totalPaid = payments.reduce((sum, p) => sum + p.monto, 0);
                const totalInterest = payments.filter(p => p.tipo === 'interes').reduce((sum, p) => sum + p.monto, 0);
                const totalArrears = payments.filter(p => p.tipo === 'mora').reduce((sum, p) => sum + p.monto, 0);

                const clientSummary = document.getElementById('clientSummary');
                clientSummary.innerHTML = `
                    <div class="col-md-2">
                        <div class="card bg-primary text-white text-center">
                            <div class="card-body">
                                <h5>${totalLoans}</h5>
                                <small>Total Préstamos</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-success text-white text-center">
                            <div class="card-body">
                                <h5>${activeLoans}</h5>
                                <small>Préstamos Activos</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-info text-white text-center">
                            <div class="card-body">
                                <h5>$${totalBorrowed.toLocaleString()}</h5>
                                <small>Total Prestado</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-warning text-white text-center">
                            <div class="card-body">
                                <h5>$${totalPaid.toLocaleString()}</h5>
                                <small>Total Pagado</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-secondary text-white text-center">
                            <div class="card-body">
                                <h5>$${totalInterest.toLocaleString()}</h5>
                                <small>Interés Pagado</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-danger text-white text-center">
                            <div class="card-body">
                                <h5>$${totalArrears.toLocaleString()}</h5>
                                <small>Atrasos</small>
                            </div>
                        </div>
                    </div>
                `;
            }

            function clearSearch() {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('clientDetails').style.display = 'none';
                selectedClient = null;
            }

            function printClientReport() {
                if (!selectedClient) {
                    alert('Selecciona un cliente primero');
                    return;
                }

                // Prepare print content
                const printDate = new Date().toLocaleDateString('es-ES');
                document.getElementById('printDate').textContent = printDate;

                const printContent = document.getElementById('printContent');
                printContent.innerHTML = `
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Información del Cliente</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Nombre:</strong> ${selectedClient.nombre} ${selectedClient.apellido}</p>
                            <p><strong>Email:</strong> ${selectedClient.email}</p>
                            <p><strong>Teléfono:</strong> ${selectedClient.telefono}</p>
                            <p><strong>Dirección:</strong> ${selectedClient.direccion || 'No especificada'}</p>
                            <p><strong>Tipo:</strong> ${selectedClient.tipo}</p>
                            <p><strong>Fecha de Registro:</strong> ${new Date(selectedClient.fecha_registro).toLocaleDateString('es-ES')}</p>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Historial de Préstamos</h5>
                        </div>
                        <div class="card-body">
                            ${document.getElementById('loansTableBody').innerHTML}
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Historial de Pagos</h5>
                        </div>
                        <div class="card-body">
                            ${document.getElementById('paymentsTableBody').innerHTML}
                        </div>
                    </div>
                `;

                window.print();
            }

            function exportClientData() {
                if (!selectedClient) {
                    alert('Selecciona un cliente primero');
                    return;
                }

                const data = {
                    client: selectedClient,
                    exportDate: new Date().toLocaleDateString('es-ES')
                };

                const csvContent = `data:text/csv;charset=utf-8,Cliente,${selectedClient.nombre} ${selectedClient.apellido}\nEmail,${selectedClient.email}\nTelefono,${selectedClient.telefono}\nFecha Exportacion,${data.exportDate}`;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `cliente_${selectedClient.nombre}_${selectedClient.apellido}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert('Datos del cliente exportados exitosamente');
            }

            function renderClientLoansTable(loans) {
                const tbody = document.getElementById('loansTableBody');
                
                if (loans.length === 0) {
                    PaginationUtils.renderEmptyTable(tbody, 7, 'fas fa-money-bill-wave', 'No hay préstamos registrados');
                    return;
                }
                
                tbody.innerHTML = '';
                loans.forEach(loan => {
                    const row = `
                        <tr>
                            <td>${loan._id}</td>
                            <td>${PaginationUtils.formatCurrency(loan.capital_inicial)}</td>
                            <td>${loan.plazo}</td>
                            <td>${loan.tasa_interes}%</td>
                            <td>${PaginationUtils.createStatusBadge(loan.estado)}</td>
                            <td>${PaginationUtils.formatDate(loan.fecha_creacion)}</td>
                            <td>${PaginationUtils.formatCurrency(loan.metrics?.saldo_actual || 0)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
            
            function searchClientLoans(loans, searchTerm) {
                return loans.filter(loan => 
                    loan._id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    loan.estado.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    loan.capital_inicial.toString().includes(searchTerm)
                );
            }
            
            function renderClientPaymentsTable(payments) {
                const tbody = document.getElementById('paymentsTableBody');
                
                if (payments.length === 0) {
                    PaginationUtils.renderEmptyTable(tbody, 5, 'fas fa-receipt', 'No hay pagos registrados');
                    return;
                }
                
                tbody.innerHTML = '';
                payments.forEach(payment => {
                    const row = `
                        <tr>
                            <td>${PaginationUtils.formatDate(payment.fecha)}</td>
                            <td>${PaginationUtils.formatCurrency(payment.monto)}</td>
                            <td>${PaginationUtils.createStatusBadge(payment.tipo)}</td>
                            <td>${payment.comprobante || '-'}</td>
                            <td><span class="badge bg-success">Confirmado</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
            
            function searchClientPayments(payments, searchTerm) {
                return payments.filter(payment => 
                    payment.tipo.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    payment.monto.toString().includes(searchTerm) ||
                    (payment.comprobante && payment.comprobante.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }

            function setupNavbarSearch() {
                const searchInput = document.querySelector('input[aria-describedby="btnNavbarSearch"]');
                const searchButton = document.getElementById('btnNavbarSearch');

                if (searchInput && searchButton) {
                    // Search on button click
                    searchButton.addEventListener('click', performNavbarSearch);

                    // Search on Enter key
                    searchInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            performNavbarSearch();
                        }
                    });
                }
            }

            async function performNavbarSearch() {
                const searchInput = document.querySelector('input[aria-describedby="btnNavbarSearch"]');
                const searchTerm = searchInput.value.trim();

                if (!searchTerm) {
                    alert('Por favor ingresa un término de búsqueda');
                    return;
                }

                // Filter clients
                const filteredClients = allClients.filter(client =>
                    (client.nombre && client.nombre.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (client.apellido && client.apellido.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (client.email && client.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (client.telefono && client.telefono.includes(searchTerm)) ||
                    (client.direccion && client.direccion.toLowerCase().includes(searchTerm.toLowerCase()))
                );

                // Show results in a modal
                showSearchResultsModal(filteredClients, searchTerm);
            }

            function showSearchResultsModal(clients, searchTerm) {
                const modalHtml = `
                    <div class="modal fade" id="searchResultsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Resultados de Búsqueda: "${searchTerm}"</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ${clients.length === 0 ?
                                        '<div class="text-center py-4"><i class="fas fa-search fa-3x text-muted mb-3"></i><p class="text-muted">No se encontraron clientes</p></div>' :
                                        `<div class="list-group">${clients.slice(0, 20).map(client => `
                                            <div class="list-group-item list-group-item-action" onclick="window.location.href='client-details.html?client=${client._id}'" style="cursor: pointer;">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h6 class="mb-1">${client.nombre} ${client.apellido}</h6>
                                                    <small class="text-muted">${client.tipo}</small>
                                                </div>
                                                <p class="mb-1"><i class="fas fa-envelope me-1"></i>${client.email}</p>
                                                <small class="text-muted"><i class="fas fa-phone me-1"></i>${client.telefono}</small>
                                            </div>
                                        `).join('')}</div>`
                                    }
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if present
                const existingModal = document.getElementById('searchResultsModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('searchResultsModal'));
                modal.show();
            }

            async function viewClientDetails(clientId) {
                try {
                    console.log('Loading client details for modal, ID:', clientId);

                    const client = allClients.find(c => c._id === clientId);
                    if (!client) {
                        alert('Cliente no encontrado en la lista local');
                        return;
                    }

                    // Show loading in modal
                    const modalBody = document.getElementById('clientDetailsModalBody');
                    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div><p>Cargando detalles del cliente...</p></div>';

                    const modal = new bootstrap.Modal(document.getElementById('clientDetailsModal'));
                    modal.show();

                    // Load client loans and payments
                    const [loansRes, paymentsRes] = await Promise.all([
                        fetch('http://localhost:3000/api/prestamos', {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        }),
                        fetch('http://localhost:3000/api/pagos', {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        })
                    ]);

                    console.log('Modal - Loans response status:', loansRes.status);
                    console.log('Modal - Payments response status:', paymentsRes.status);

                    if (loansRes.ok && paymentsRes.ok) {
                        const allLoans = await loansRes.json();
                        const allPayments = await paymentsRes.json();

                        const clientLoans = allLoans.filter(loan => loan.cliente_id === clientId);
                        const clientPayments = allPayments.filter(payment => payment.cliente_info && payment.cliente_info.email === client.email);

                        console.log('Modal - Filtered loans:', clientLoans.length);
                        console.log('Modal - Filtered payments:', clientPayments.length);

                        // Build modal content
                        modalBody.innerHTML = `
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Información Personal</h6>
                                    <p><strong>Nombre:</strong> ${client.nombre} ${client.apellido}</p>
                                    <p><strong>Email:</strong> ${client.email}</p>
                                    <p><strong>Teléfono:</strong> ${client.telefono}</p>
                                    <p><strong>Dirección:</strong> ${client.direccion || 'No especificada'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Estadísticas Generales</h6>
                                    <p><strong>Tipo de Cliente:</strong> <span class="badge bg-info">${client.tipo}</span></p>
                                    <p><strong>Fecha de Registro:</strong> ${new Date(client.fecha_registro).toLocaleDateString('es-ES')}</p>
                                    <p><strong>Total de Préstamos:</strong> ${clientLoans.length}</p>
                                    <p><strong>Total de Pagos:</strong> ${clientPayments.length}</p>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6>Historial de Préstamos</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Capital</th>
                                                <th>Estado</th>
                                                <th>Fecha</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${clientLoans.length === 0 ? '<tr><td colspan="4" class="text-center">No hay préstamos</td></tr>' :
                                                clientLoans.map(loan => `
                                                    <tr>
                                                        <td>${loan._id.substring(0, 8)}...</td>
                                                        <td>$${loan.capital_inicial.toLocaleString()}</td>
                                                        <td><span class="badge bg-${loan.estado === 'activo' ? 'success' : 'secondary'}">${loan.estado}</span></td>
                                                        <td>${new Date(loan.fecha_creacion).toLocaleDateString('es-ES')}</td>
                                                    </tr>
                                                `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6>Historial de Pagos</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Monto</th>
                                                <th>Tipo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${clientPayments.length === 0 ? '<tr><td colspan="3" class="text-center">No hay pagos</td></tr>' :
                                                clientPayments.slice(0, 10).map(payment => `
                                                    <tr>
                                                        <td>${new Date(payment.fecha).toLocaleDateString('es-ES')}</td>
                                                        <td>$${payment.monto.toLocaleString()}</td>
                                                        <td><span class="badge bg-${payment.tipo === 'pago' ? 'primary' : payment.tipo === 'interes' ? 'warning' : 'danger'}">${payment.tipo}</span></td>
                                                    </tr>
                                                `).join('')}
                                        </tbody>
                                    </table>
                                    ${clientPayments.length > 10 ? `<small class="text-muted">Mostrando 10 de ${clientPayments.length} pagos</small>` : ''}
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6>Resumen Estadístico</h6>
                                <div class="row">
                                    ${(() => {
                                        const totalLoans = clientLoans.length;
                                        const activeLoans = clientLoans.filter(l => l.estado === 'activo').length;
                                        const totalBorrowed = clientLoans.reduce((sum, l) => sum + l.capital_inicial, 0);
                                        const totalPaid = clientPayments.reduce((sum, p) => sum + p.monto, 0);
                                        return `
                                            <div class="col-md-3">
                                                <div class="card bg-primary text-white text-center">
                                                    <div class="card-body py-2">
                                                        <h6>${totalLoans}</h6>
                                                        <small>Total Préstamos</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-success text-white text-center">
                                                    <div class="card-body py-2">
                                                        <h6>${activeLoans}</h6>
                                                        <small>Activos</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-info text-white text-center">
                                                    <div class="card-body py-2">
                                                        <h6>$${totalBorrowed.toLocaleString()}</h6>
                                                        <small>Prestado</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-warning text-white text-center">
                                                    <div class="card-body py-2">
                                                        <h6>$${totalPaid.toLocaleString()}</h6>
                                                        <small>Pagado</small>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    })()}
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6>Visualización de Datos</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Estado de Préstamos</h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="modalLoansStatusChart" width="200" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Tipos de Pago</h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="modalPaymentTypesChart" width="200" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Create charts for modal
                        setTimeout(() => {
                            createModalCharts(clientLoans, clientPayments);
                        }, 100);

                        // Store client for export
                        selectedClient = client;
                        window.currentClientLoans = clientLoans;
                        window.currentClientPayments = clientPayments;

                    } else {
                        throw new Error('Error al cargar préstamos y pagos del cliente');
                    }
                } catch (err) {
                    console.error('Error loading client details for modal:', err);
                    alert(`Error al cargar los detalles del cliente: ${err.message}`);

                    // Close modal if open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('clientDetailsModal'));
                    if (modal) {
                        modal.hide();
                    }
                }
            }

            function createModalCharts(clientLoans, clientPayments) {
                // Destroy existing modal charts if they exist
                const modalChartIds = ['modalLoansStatusChart', 'modalPaymentTypesChart'];
                modalChartIds.forEach(id => {
                    const existingChart = Chart.getChart(id);
                    if (existingChart) {
                        existingChart.destroy();
                    }
                });

                // 1. Modal Loans Status Chart (Doughnut)
                const loanStatuses = {};
                clientLoans.forEach(loan => {
                    const status = loan.estado || 'desconocido';
                    loanStatuses[status] = (loanStatuses[status] || 0) + 1;
                });

                const statusLabels = Object.keys(loanStatuses);
                const statusData = Object.values(loanStatuses);
                const statusColors = statusLabels.map(status => {
                    const colorMap = {
                        'activo': '#28a745',
                        'pagado': '#007bff',
                        'vencido': '#dc3545',
                        'desconocido': '#6c757d'
                    };
                    return colorMap[status] || '#6c757d';
                });

                new Chart(document.getElementById('modalLoansStatusChart'), {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            data: statusData,
                            backgroundColor: statusColors,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                });

                // 2. Modal Payment Types Chart (Pie)
                const paymentTypes = {};
                clientPayments.forEach(payment => {
                    const type = payment.tipo || 'desconocido';
                    paymentTypes[type] = (paymentTypes[type] || 0) + payment.monto;
                });

                const typeLabels = Object.keys(paymentTypes);
                const typeData = Object.values(paymentTypes);
                const typeColors = typeLabels.map(type => {
                    const colorMap = {
                        'pago': '#28a745',
                        'interes': '#ffc107',
                        'mora': '#dc3545',
                        'desconocido': '#6c757d'
                    };
                    return colorMap[type] || '#6c757d';
                });

                new Chart(document.getElementById('modalPaymentTypesChart'), {
                    type: 'pie',
                    data: {
                        labels: typeLabels,
                        datasets: [{
                            data: typeData,
                            backgroundColor: typeColors,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: $${context.parsed.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function exportClientFromModal() {
                if (!selectedClient) {
                    alert('No hay cliente seleccionado');
                    return;
                }

                const data = {
                    client: selectedClient,
                    loans: window.currentClientLoans || [],
                    payments: window.currentClientPayments || [],
                    exportDate: new Date().toLocaleDateString('es-ES')
                };

                const csvContent = `data:text/csv;charset=utf-8,Cliente,${selectedClient.nombre} ${selectedClient.apellido}\nEmail,${selectedClient.email}\nTelefono,${selectedClient.telefono}\nTipo,${selectedClient.tipo}\nFecha Registro,${data.exportDate}\n\nPréstamos:\nID,Capital,Estado,Fecha\n${data.loans.map(l => `${l._id},${l.capital_inicial},${l.estado},${new Date(l.fecha_creacion).toLocaleDateString('es-ES')}`).join('\n')}\n\nPagos:\nFecha,Monto,Tipo\n${data.payments.map(p => `${new Date(p.fecha).toLocaleDateString('es-ES')},${p.monto},${p.tipo}`).join('\n')}`;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `cliente_completo_${selectedClient.nombre}_${selectedClient.apellido}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert('Datos completos del cliente exportados exitosamente');
            }

            function exportSearchResults() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                if (!searchTerm) {
                    alert('Realiza una búsqueda primero');
                    return;
                }

                const filteredClients = allClients.filter(client =>
                    (client.nombre && client.nombre.toLowerCase().includes(searchTerm)) ||
                    (client.apellido && client.apellido.toLowerCase().includes(searchTerm)) ||
                    (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                    (client.telefono && client.telefono.includes(searchTerm)) ||
                    (client.direccion && client.direccion.toLowerCase().includes(searchTerm))
                );

                if (filteredClients.length === 0) {
                    alert('No hay resultados para exportar');
                    return;
                }

                const csvContent = `data:text/csv;charset=utf-8,Término de búsqueda:,${searchTerm}\nFecha de exportación:,${new Date().toLocaleDateString('es-ES')}\n\nNombre Completo,Email,Teléfono,Dirección,Tipo,Fecha Registro\n${filteredClients.map(client => `"${client.nombre} ${client.apellido}","${client.email}","${client.telefono}","${client.direccion || 'No especificada'}","${client.tipo}","${new Date(client.fecha_registro).toLocaleDateString('es-ES')}"`).join('\n')}`;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `resultados_busqueda_clientes_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(`Resultados de búsqueda exportados exitosamente (${filteredClients.length} clientes)`);
            }

            function logout() {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        </script>
    </body>
</html>