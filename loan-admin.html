<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Admin Dashboard - Sistema de Préstamos</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
        <link href="css/styles.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    </head>
    <body class="sb-nav-fixed">
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
            <!-- Navbar Brand-->
            <a class="navbar-brand ps-3" href="loan-admin.html">Sistema de Préstamos</a>
            <!-- Sidebar Toggle-->
            <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
            <!-- Navbar Search-->
            <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
                <div class="input-group">
                    <input class="form-control" type="text" placeholder="Buscar..." aria-label="Search for..." aria-describedby="btnNavbarSearch" />
                    <button class="btn btn-primary" id="btnNavbarSearch" type="button"><i class="fas fa-search"></i></button>
                </div>
            </form>
            <!-- Navbar-->
            <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="#" onclick="logout()">Cerrar Sesión</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <div class="sb-sidenav-menu-heading">Principal</div>
                            <a class="nav-link" href="loan-admin.html">
                                <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                                Dashboard
                            </a>
                            <div class="sb-sidenav-menu-heading">Gestión</div>
                            <a class="nav-link" href="#" onclick="showClients()">
                                <div class="sb-nav-link-icon"><i class="fas fa-users"></i></div>
                                Clientes
                            </a>
                            <a class="nav-link" href="#" onclick="showLoans()">
                                <div class="sb-nav-link-icon"><i class="fas fa-money-bill-wave"></i></div>
                                Préstamos
                            </a>
                            <a class="nav-link" href="#" onclick="showPayments()">
                                <div class="sb-nav-link-icon"><i class="fas fa-receipt"></i></div>
                                Pagos
                            </a>
                            <a class="nav-link" href="#" onclick="showReports()">
                                <div class="sb-nav-link-icon"><i class="fas fa-chart-bar"></i></div>
                                Reportes
                            </a>
                        </div>
                    </div>
                    <div class="sb-sidenav-footer">
                        <div class="small">Conectado como Admin</div>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h1 class="mt-4 mb-0">Panel de Administración</h1>
                                <p class="text-muted">Sistema de Gestión de Préstamos</p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">Última actualización</small>
                                <small class="text-muted" id="lastUpdate"></small>
                            </div>
                        </div>
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item active">
                                <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                            </li>
                        </ol>
                        <!-- Stats Cards -->
                        <div class="row mb-4">
                            <div class="col-xl-3 col-md-6">
                                <div class="card bg-primary text-white mb-4">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-white-75 small">Total Clientes</div>
                                                <div class="text-lg fw-bold" id="totalClients">0</div>
                                            </div>
                                            <i class="fas fa-users fa-2x text-white-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card bg-success text-white mb-4">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-white-75 small">Préstamos Activos</div>
                                                <div class="text-lg fw-bold" id="activeLoans">0</div>
                                            </div>
                                            <i class="fas fa-money-bill-wave fa-2x text-white-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card bg-warning text-white mb-4">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-white-75 small">Cartera Total</div>
                                                <div class="text-lg fw-bold" id="totalPortfolio">$0</div>
                                            </div>
                                            <i class="fas fa-dollar-sign fa-2x text-white-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card bg-danger text-white mb-4">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-white-75 small">Préstamos Vencidos</div>
                                                <div class="text-lg fw-bold" id="overdueLoans">0</div>
                                            </div>
                                            <i class="fas fa-exclamation-triangle fa-2x text-white-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content Area -->
                        <!-- Export Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-download me-1"></i>
                                Exportar Datos
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-primary w-100" onclick="exportClients()">
                                            <i class="fas fa-users me-2"></i>Exportar Clientes
                                        </button>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-success w-100" onclick="exportLoans()">
                                            <i class="fas fa-money-bill-wave me-2"></i>Exportar Préstamos
                                        </button>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-warning w-100" onclick="exportPayments()">
                                            <i class="fas fa-receipt me-2"></i>Exportar Pagos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="mainContent">
                            <!-- Default dashboard content will be loaded here -->
                        </div>
                    </div>
                </main>
                <footer class="py-4 bg-light mt-auto">
                    <div class="container-fluid px-4">
                        <div class="d-flex align-items-center justify-content-between small">
                            <div class="text-muted">Copyright &copy; Sistema de Préstamos 2024</div>
                        </div>
                    </div>
                </footer>
            </div>
        </div>

        <!-- Modals -->
        <!-- Client Modal -->
        <div class="modal fade" id="clientModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="clientModalTitle">Registrar Cliente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="clientForm">
                            <div class="mb-3">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="clientNombre" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="clientApellido" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="clientTelefono" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="clientEmail" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Dirección</label>
                                <textarea class="form-control" id="clientDireccion" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" id="clientTipo">
                                    <option value="individual">Individual</option>
                                    <option value="grupo">Grupo</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="saveClient()">Guardar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Modal -->
        <div class="modal fade" id="loanModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Crear Préstamo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="loanForm">
                            <div class="mb-3">
                                <label class="form-label">Cliente</label>
                                <select class="form-select" id="loanCliente" required>
                                    <option value="">Seleccionar cliente...</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Capital Inicial</label>
                                    <input type="number" class="form-control" id="loanCapital" step="0.01" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Plazo (meses)</label>
                                    <input type="number" class="form-control" id="loanPlazo" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Frecuencia de Pago</label>
                                    <input type="text" class="form-control" value="Cada 15 días" readonly>
                                    <small class="text-muted">Frecuencia fija de 15 días</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tasa de Interés (%)</label>
                                    <input type="number" class="form-control" id="loanTasa" step="0.01" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Condiciones de Mora</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Tasa de Mora (%)</label>
                                        <input type="number" class="form-control" id="moraTasa" step="0.01" value="2">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Días de Gracia</label>
                                        <input type="number" class="form-control" id="moraDias" value="5">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="saveLoan()">Crear Préstamo</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div class="modal fade" id="paymentModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Registrar Pago</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="paymentForm">
                            <div class="mb-3">
                                <label class="form-label">Préstamo</label>
                                <select class="form-select" id="paymentPrestamo" required>
                                    <option value="">Seleccionar préstamo...</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Fecha</label>
                                    <input type="date" class="form-control" id="paymentFecha" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Monto</label>
                                    <input type="number" class="form-control" id="paymentMonto" step="0.01" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" id="paymentTipo">
                                    <option value="pago">Pago</option>
                                    <option value="interes">Interés</option>
                                    <option value="mora">Mora</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Comprobante</label>
                                <input type="text" class="form-control" id="paymentComprobante" placeholder="Número de comprobante">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="savePayment()">Registrar Pago</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="js/scripts.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                validateLoanAdminAccess();
                loadDashboard();
            });

            function validateLoanAdminAccess() {
                const token = localStorage.getItem('token');
                const role = localStorage.getItem('role');

                if (!token || role !== 'administradores2') {
                    alert('Acceso no autorizado. Debes iniciar sesión como administrador de préstamos.');
                    window.location.href = 'login.html';
                    return;
                }

                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-ES');
            }

            async function loadDashboard() {
                try {
                    const [clientsRes, loansRes] = await Promise.all([
                        fetch('http://localhost:3000/api/clientes', {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        }),
                        fetch('http://localhost:3000/api/prestamos', {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        })
                    ]);

                    if (clientsRes.ok) {
                        const clients = await clientsRes.json();
                        document.getElementById('totalClients').textContent = clients.length;
                    }

                    if (loansRes.ok) {
                        const loans = await loansRes.json();
                        const activeLoans = loans.filter(l => l.estado === 'activo').length;
                        const totalPortfolio = loans.reduce((sum, l) => sum + l.capital_inicial, 0);
                        const overdueLoans = loans.filter(l => l.metrics && l.metrics.diferencia > 0).length;

                        document.getElementById('activeLoans').textContent = activeLoans;
                        document.getElementById('totalPortfolio').textContent = `$${totalPortfolio.toLocaleString()}`;
                        document.getElementById('overdueLoans').textContent = overdueLoans;
                    }
                } catch (err) {
                    console.error('Error loading dashboard:', err);
                }
            }

            function showClients() {
                const content = `
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-users me-1"></i>
                                Gestión de Clientes
                            </div>
                            <button class="btn btn-primary" onclick="openClientModal()">
                                <i class="fas fa-plus me-1"></i>Agregar Cliente
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="clientsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Email</th>
                                            <th>Teléfono</th>
                                            <th>Tipo</th>
                                            <th>Fecha Registro</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clientsTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Cargando clientes...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('mainContent').innerHTML = content;
                loadClients();
            }

            async function loadClients() {
                try {
                    const response = await fetch('http://localhost:3000/api/clientes', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (response.ok) {
                        const clients = await response.json();
                        allClients = clients;
                        displayClients(clients);
                    }
                } catch (err) {
                    console.error('Error loading clients:', err);
                }
            }

            function displayClients(clients) {
                const tbody = document.getElementById('clientsTableBody');
                if (clients.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No hay clientes registrados</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = '';
                clients.forEach(client => {
                    const row = `
                        <tr>
                            <td>${client.nombre} ${client.apellido}</td>
                            <td>${client.email}</td>
                            <td>${client.telefono}</td>
                            <td><span class="badge bg-info">${client.tipo}</span></td>
                            <td>${new Date(client.fecha_registro).toLocaleDateString('es-ES')}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editClient('${client._id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            function showLoans() {
                const content = `
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-money-bill-wave me-1"></i>
                                Gestión de Préstamos
                            </div>
                            <button class="btn btn-success" onclick="openLoanModal()">
                                <i class="fas fa-plus me-1"></i>Crear Préstamo
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="loansTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Capital</th>
                                            <th>Estado</th>
                                            <th>Saldo Actual</th>
                                            <th>Fecha Creación</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loansTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Cargando préstamos...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('mainContent').innerHTML = content;
                loadLoans();
            }

            async function loadLoans() {
                try {
                    const response = await fetch('http://localhost:3000/api/prestamos', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (response.ok) {
                        const loans = await response.json();
                        allLoans = loans;
                        displayLoans(loans);
                    }
                } catch (err) {
                    console.error('Error loading loans:', err);
                }
            }

            function displayLoans(loans) {
                const tbody = document.getElementById('loansTableBody');
                if (loans.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No hay préstamos registrados</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = '';
                loans.forEach(loan => {
                    const statusBadge = loan.estado === 'activo' ? 'success' : 'secondary';
                    const row = `
                        <tr>
                            <td>Cliente ID: ${loan.cliente_id}</td>
                            <td>$${loan.capital_inicial.toLocaleString()}</td>
                            <td><span class="badge bg-${statusBadge}">${loan.estado}</span></td>
                            <td>$${loan.metrics?.saldo_actual?.toLocaleString() || '0'}</td>
                            <td>${new Date(loan.fecha_creacion).toLocaleDateString('es-ES')}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewLoanDetails('${loan._id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            function showPayments() {
                const content = `
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-receipt me-1"></i>
                                Registro de Pagos
                            </div>
                            <button class="btn btn-warning" onclick="openPaymentModal()">
                                <i class="fas fa-plus me-1"></i>Registrar Pago
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="paymentsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Préstamo ID</th>
                                            <th>Fecha</th>
                                            <th>Monto</th>
                                            <th>Tipo</th>
                                            <th>Comprobante</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsTableBody">
                                        <tr>
                                            <td colspan="5" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Cargando pagos...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('mainContent').innerHTML = content;
                loadPayments();
            }

            async function loadPayments() {
                try {
                    const response = await fetch('http://localhost:3000/api/pagos', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (response.ok) {
                        const payments = await response.json();
                        allPayments = payments;
                        displayPayments(payments);
                    }
                } catch (err) {
                    console.error('Error loading payments:', err);
                }
            }

            function displayPayments(payments) {
                const tbody = document.getElementById('paymentsTableBody');
                if (payments.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No hay pagos registrados</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = '';
                payments.forEach(payment => {
                    const typeBadge = payment.tipo === 'pago' ? 'success' : payment.tipo === 'interes' ? 'info' : 'warning';
                    const row = `
                        <tr>
                            <td>${payment.prestamo_id}</td>
                            <td>${new Date(payment.fecha).toLocaleDateString('es-ES')}</td>
                            <td>$${payment.monto.toLocaleString()}</td>
                            <td><span class="badge bg-${typeBadge}">${payment.tipo}</span></td>
                            <td>${payment.comprobante || '-'}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            function showReports() {
                const content = `
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-chart-bar me-1"></i>
                            Reportes y Estadísticas
                        </div>
                        <div class="card-body">
                            <p>Reportes consolidados estarán disponibles próximamente.</p>
                        </div>
                    </div>
                `;
                document.getElementById('mainContent').innerHTML = content;
            }

            function openClientModal() {
                document.getElementById('clientForm').reset();
                new bootstrap.Modal(document.getElementById('clientModal')).show();
            }

            async function saveClient() {
                const formData = {
                    nombre: document.getElementById('clientNombre').value,
                    apellido: document.getElementById('clientApellido').value,
                    telefono: document.getElementById('clientTelefono').value,
                    email: document.getElementById('clientEmail').value,
                    direccion: document.getElementById('clientDireccion').value,
                    tipo: document.getElementById('clientTipo').value
                };

                try {
                    const response = await fetch('http://localhost:3000/api/clientes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
                        loadClients();
                        loadDashboard();
                        alert('Cliente registrado exitosamente');
                    } else {
                        alert('Error al registrar cliente');
                    }
                } catch (err) {
                    console.error('Error saving client:', err);
                    alert('Error de conexión');
                }
            }

            async function openLoanModal() {
                // Load clients for dropdown
                try {
                    const response = await fetch('http://localhost:3000/api/clientes', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (response.ok) {
                        const clients = await response.json();
                        const select = document.getElementById('loanCliente');
                        select.innerHTML = '<option value="">Seleccionar cliente...</option>';
                        clients.forEach(client => {
                            select.innerHTML += `<option value="${client._id}">${client.nombre} ${client.apellido}</option>`;
                        });
                    }
                } catch (err) {
                    console.error('Error loading clients for loan:', err);
                }

                document.getElementById('loanForm').reset();
                new bootstrap.Modal(document.getElementById('loanModal')).show();
            }

            async function saveLoan() {
                const formData = {
                    cliente_id: document.getElementById('loanCliente').value,
                    capital_inicial: document.getElementById('loanCapital').value,
                    plazo: document.getElementById('loanPlazo').value,
                    frecuencia_pago: '15 días',
                    tasa_interes: document.getElementById('loanTasa').value,
                    condiciones_mora: {
                        tasa_mora: document.getElementById('moraTasa').value,
                        dias_gracia: document.getElementById('moraDias').value
                    }
                };

                try {
                    const response = await fetch('http://localhost:3000/api/prestamos', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        bootstrap.Modal.getInstance(document.getElementById('loanModal')).hide();
                        loadLoans();
                        loadDashboard();
                        alert('Préstamo creado exitosamente');
                    } else {
                        alert('Error al crear préstamo');
                    }
                } catch (err) {
                    console.error('Error saving loan:', err);
                    alert('Error de conexión');
                }
            }

            async function openPaymentModal() {
                // Load loans for dropdown
                try {
                    const response = await fetch('http://localhost:3000/api/prestamos', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (response.ok) {
                        const loans = await response.json();
                        const select = document.getElementById('paymentPrestamo');
                        select.innerHTML = '<option value="">Seleccionar préstamo...</option>';
                        loans.forEach(loan => {
                            select.innerHTML += `<option value="${loan._id}">Cliente ID: ${loan.cliente_id} - $${loan.capital_inicial}</option>`;
                        });
                    }
                } catch (err) {
                    console.error('Error loading loans for payment:', err);
                }

                document.getElementById('paymentForm').reset();
                document.getElementById('paymentFecha').value = new Date().toISOString().split('T')[0];
                new bootstrap.Modal(document.getElementById('paymentModal')).show();
            }

            async function savePayment() {
                const formData = {
                    prestamo_id: document.getElementById('paymentPrestamo').value,
                    fecha: document.getElementById('paymentFecha').value,
                    monto: document.getElementById('paymentMonto').value,
                    tipo: document.getElementById('paymentTipo').value,
                    comprobante: document.getElementById('paymentComprobante').value
                };

                try {
                    const response = await fetch('http://localhost:3000/api/pagos', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                        loadPayments();
                        loadLoans(); // Refresh loans to update metrics
                        loadDashboard();
                        alert('Pago registrado exitosamente');
                    } else {
                        alert('Error al registrar pago');
                    }
                } catch (err) {
                    console.error('Error saving payment:', err);
                    alert('Error de conexión');
                }
            }

            function exportClients() {
                const csvContent = "data:text/csv;charset=utf-8," +
                    "Nombre,Apellido,Email,Teléfono,Dirección,Tipo,Fecha Registro\n" +
                    allClients.map(client =>
                        `"${client.nombre}","${client.apellido}","${client.email}","${client.telefono}","${client.direccion}","${client.tipo}","${new Date(client.fecha_registro).toLocaleDateString('es-ES')}"`
                    ).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `clientes_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportLoans() {
                const csvContent = "data:text/csv;charset=utf-8," +
                    "Cliente ID,Capital Inicial,Plazo,Frecuencia,Tasa Interes,Estado,Saldo Actual,Total Pagado,Fecha Creacion\n" +
                    allLoans.map(loan =>
                        `"${loan.cliente_id}","${loan.capital_inicial}","${loan.plazo}","${loan.frecuencia_pago}","${loan.tasa_interes}","${loan.estado}","${loan.metrics?.saldo_actual || 0}","${loan.metrics?.total_pagado || 0}","${new Date(loan.fecha_creacion).toLocaleDateString('es-ES')}"`
                    ).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `prestamos_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportPayments() {
                const csvContent = "data:text/csv;charset=utf-8," +
                    "Prestamo ID,Fecha,Monto,Tipo,Comprobante\n" +
                    allPayments.map(payment =>
                        `"${payment.prestamo_id}","${new Date(payment.fecha).toLocaleDateString('es-ES')}","${payment.monto}","${payment.tipo}","${payment.comprobante || ''}"`
                    ).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `pagos_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function logout() {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        </script>
    </body>
</html>